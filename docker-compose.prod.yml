# ==========================================
# NatJoub - Production Docker Compose
# ==========================================
# This configuration is for production-like testing
# NOT for actual production deployment (use orchestrators like Kubernetes for that)
# Usage: docker-compose -f docker-compose.prod.yml up -d

version: '3.8'

# ==========================================
# Services Definition
# ==========================================
services:
  # ------------------------------------------
  # Backend Application (Node.js/Express)
  # ------------------------------------------
  app:
    container_name: natjoub-backend-prod
    build:
      context: .
      dockerfile: Dockerfile
      target: production  # Use production stage from multi-stage build
      args:
        NODE_VERSION: 20

    # Use environment file for production
    env_file:
      - .env.production  # Use separate production env file
    environment:
      # Production-specific overrides
      - NODE_ENV=production
      - DB_HOST=db
      - DB_PORT=5432
      - RUN_MIGRATIONS=false  # Manually run migrations in production

    # Port mapping
    ports:
      - "3000:3000"

    # NO source code mounting in production (use image only)
    volumes:
      # Only mount necessary runtime volumes
      - ./logs:/usr/src/app/logs  # Application logs (if you write to logs/)

    # Service dependencies
    depends_on:
      db:
        condition: service_healthy

    # Restart policy - always restart in production
    restart: always

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

    # Attach to custom network
    networks:
      - natjoub-network

    # Health check (inherited from Dockerfile)
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ------------------------------------------
  # PostgreSQL Database
  # ------------------------------------------
  db:
    container_name: natjoub-postgres-prod
    image: postgres:15-alpine

    # Environment variables
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASS}
      POSTGRES_DB: ${DB_NAME}
      # Production optimizations
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
      # Disable verbose logging in production
      POSTGRES_LOG_STATEMENT: none
      POSTGRES_LOG_MIN_DURATION_STATEMENT: 1000  # Log queries > 1s

    # Port mapping (can be removed in production if not needed externally)
    ports:
      - "5432:5432"  # Using standard port in production

    # Persistent volume for database data
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
      # Production backup location
      - ./backups:/backups

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Restart policy
    restart: always

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

    # Attach to custom network
    networks:
      - natjoub-network

  # ------------------------------------------
  # Nginx (Reverse Proxy) - Optional
  # ------------------------------------------
  # Uncomment for production reverse proxy setup
  # nginx:
  #   container_name: natjoub-nginx-prod
  #   image: nginx:alpine
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./nginx/ssl:/etc/nginx/ssl:ro
  #     - ./logs/nginx:/var/log/nginx
  #   depends_on:
  #     - app
  #   restart: always
  #   networks:
  #     - natjoub-network

# ==========================================
# Networks Definition
# ==========================================
networks:
  natjoub-network:
    driver: bridge
    # Production: Consider using overlay network for swarm
    # driver: overlay

# ==========================================
# Volumes Definition
# ==========================================
volumes:
  # PostgreSQL production data
  postgres_data_prod:
    driver: local
    # Production: Consider using named volumes with backup strategies
    # or external storage solutions

# ==========================================
# Production Notes
# ==========================================
# 1. Use secrets management (Docker secrets, Vault, etc.) instead of .env files
# 2. Implement proper logging (ELK stack, CloudWatch, etc.)
# 3. Set up monitoring (Prometheus, Grafana, New Relic, etc.)
# 4. Configure SSL/TLS certificates (Let's Encrypt, etc.)
# 5. Implement backup strategies for database
# 6. Use container orchestration (Kubernetes, Docker Swarm, etc.)
# 7. Set up CI/CD pipelines for automated deployments
# 8. Configure firewall rules and security groups
# 9. Implement rate limiting and DDoS protection
# 10. Set up log rotation and retention policies
